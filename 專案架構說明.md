# Urgency 遊戲專案 - 程式碼架構說明

## 📁 專案結構總覽

```
Assets/Scripts/
├── 核心系統 (Root)
├── Managers/     # 全域管理器
├── Mobs/         # 敵人 AI
├── Object/       # 場景物件互動
├── Player/       # 玩家相關
├── Refugees/     # 難民系統
├── UI/           # 使用者介面
└── Weapons/      # 武器系統
```

---

## 🎮 核心系統 (Root Scripts)

### `Informations.cs` - 全域遊戲資訊中心
**用途**：管理所有玩家狀態、彈藥、背包等核心數據的靜態類別。

**主要功能**：
- **玩家狀態**：`Heart` (生命)、`Armor` (護甲)、`BatteryPower` (電池)、`Kerosene` (煤油)
- **彈藥管理**：`Ammo_Pistol`、`Ammo_Rifles`、`Arrows`
- **背包系統**：`Containers` 列表、`SelectedContainer` 當前選中槽位
- **物品操作**：`PickupItem()`、`DropSelectedItem()`、`SwapContainers()`
- **玩家引用**：`Player` (快取玩家物件)、`PlayerPosition` (玩家座標)

**運作方式**：作為靜態類別，全遊戲任何地方都可直接存取 `Informations.Heart` 等屬性。

---

### `IDamageable.cs` - 傷害介面
**用途**：統一所有可受傷實體的介面。

```csharp
public interface IDamageable
{
    void TakeDamage(float damage, float knockbackDistance, float knockbackVelocity, Vector2 sourcePosition);
    GameObject GetGameObject();
}
```

**實作者**：`Player`、`Zombie`、`RangedZombie`

---

### `QTEStatus.cs` - QTE 狀態管理
**用途**：追蹤 Quick Time Event 的全域狀態。

**屬性**：
- `IsSuccess` - QTE 是否成功
- `IsFinish` - QTE 是否結束
- `AllowCallQTE` - 是否允許觸發新 QTE
- `IsInQTE` - 是否正在進行 QTE
- `OnQTEForceFail` - 外部強制失敗事件 (如受傷)

---

### `ItemWorldPickup.cs` - 世界物品拾取
**用途**：讓玩家可以撿起場景中的物品放入背包。

---

### `EquippedItemDisplay.cs` - 裝備顯示
**用途**：顯示當前裝備的物品圖示。

---

## 🏢 管理器系統 (Managers/)

### `GameSceneManager.cs` - 場景管理
**用途**：處理場景切換、載入畫面、勝利/死亡畫面。

**主要方法**：
- `LoadScene(string sceneName)` - 載入指定場景
- `LoadVictoryScene()` - 載入勝利畫面
- `LoadDeathScene()` - 載入死亡畫面
- `RestartCurrentScene()` - 重新開始當前關卡

---

### `SoundManager.cs` - 音效管理 (Singleton)
**用途**：管理全域 SFX 音量。

**關鍵方法**：
- `GetVolume()` - 返回全域 SFX 音量倍率
- `SetVolume(float v)` - 設定音量
- `PlaySFX(AudioClip, Vector3, float)` - 播放空間音效
- `PlayUISound(AudioClip, float)` - 播放 UI 音效

**運作方式**：所有音效播放時會乘以 `globalSFXVolume`，確保滑桿控制生效。

---

### `MusicManager.cs` - 音樂管理
**用途**：處理背景音樂的播放、切換、音量控制。

---

### `ObjectPoolManager.cs` - 物件池管理
**用途**：優化子彈等頻繁生成/銷毀的物件。

**主要方法**：
- `Spawn(GameObject prefab, Vector3 position, Quaternion rotation)` - 從池取出物件
- `Recycle(GameObject obj)` - 回收物件到池中

---

### `SettingsManager.cs` - 設定管理
**用途**：儲存/讀取玩家設定 (音量、畫質等)。

---

### `MenuManager.cs` - 選單管理
**用途**：處理主選單的邏輯。

---

### `LevelSelectManager.cs` - 關卡選擇
**用途**：管理關卡選擇畫面。

---

### `StageManager.cs` - 關卡進度
**用途**：追蹤關卡完成狀態。

---

## 👹 敵人系統 (Mobs/)

### `Zombie.cs` - 基礎殭屍 AI
**用途**：標準近戰殭屍的行為控制。

**主要特性**：
- **偵測範圍**：`DetectDistance` 內會開始追蹤玩家
- **攻擊模式**：進入 `MeleeAttackDistance` 後發動攻擊
- **障礙迴避**：使用 Raycast 偵測並繞過障礙物
- **卡住脫困**：偵測到長時間無法移動會隨機轉向
- **擊退系統**：受傷時會被推開

**實作介面**：`IDamageable`

---

### `RangedZombie.cs` - 遠程殭屍 / Boss
**用途**：具備遠程攻擊能力的殭屍，可設為 Boss。

**額外特性**：
- **遠程攻擊**：在 `rangedAttackMinDistance` ~ `rangedAttackMaxDistance` 範圍內發射子彈
- **Boss 模式**：啟用 `isBoss` 後會有專屬大型血條
- **血條顯示**：進入偵測範圍才顯示，離開則隱藏

---

### `EnemyBullet.cs` - 敵人子彈
**用途**：敵人發射的投射物。

**屬性**：
- `Damage` - 傷害值
- `FlyingSpeed` - 飛行速度
- `LifeTime` - 存活時間

---

### `ZombieMoan.cs` - 殭屍音效
**用途**：讓殭屍隨機發出呻吟聲。

**運作方式**：每隔隨機時間播放音效，音量受全域 SFX 倍率影響。

---

## 🚪 場景物件 (Object/)

### `DoorController.cs` - 門控制器
**用途**：處理門的開關、上鎖、解鎖流程。

**主要功能**：
- **自動開關**：玩家進入/離開觸發區時自動開關
- **鎖門系統**：需要對應 `requiredKeyId` 的鑰匙
- **QTE 解鎖**：上鎖的門需通過 QTE 挑戰才能開啟
- **連動門**：多扇門可同步開關 (雙開門)
- **開門方向**：根據玩家位置決定向內或向外推

---

### `DoorTrigger.cs` - 門觸發區
**用途**：偵測玩家進入/離開，通知 DoorController。

---

### `ChestController.cs` - 寶箱控制
**用途**：可互動的寶箱，支援上鎖/解鎖。

---

### `KeyItem.cs` - 鑰匙物品
**用途**：可被撿取的鑰匙，用於開門/開箱。

**靜態方法**：
- `GetHeldDoorKey(string keyId)` - 檢查玩家是否持有指定鑰匙

---

### `AmmoPickup.cs` - 彈藥拾取
**用途**：可撿取的彈藥包。

**屬性**：
- `ammoType` - 彈藥類型 (Pistol/Rifle/Arrow)
- `amount` - 數量

---

### `HealthPickup2D.cs` - 血包拾取
**用途**：回復玩家生命值。

**特殊功能**：
- `pickupThreshold` - 血量低於此百分比才能撿取 (預設 70%)

---

### `LootDropper.cs` - 戰利品掉落
**用途**：敵人死亡時掉落物品。

---

### `HurtZone.cs` - 傷害區域
**用途**：持續對玩家造成傷害的區域。

---

### `MusicTrigger.cs` - 音樂觸發
**用途**：進入區域時切換背景音樂。

---

### `RoomLightController.cs` - 房間燈光
**用途**：控制房間的燈光開關。

---

### `TeleportSimple2D.cs` - 傳送點
**用途**：將玩家傳送到指定位置。

---

### `CharacterPass.cs` - 角色通行
**用途**：控制特定角色的通行權限。

---

### `RequiresKeyAnyOf2D.cs` - 多鑰匙門
**用途**：需要多把鑰匙中的任一把才能開啟。

---

## 🎯 玩家系統 (Player/)

### `Player.cs` - 玩家主控制器
**用途**：處理玩家的所有核心行為。

**主要功能**：
- **移動**：WASD 控制，速度為 `Speed`
- **旋轉**：滑鼠控制朝向
- **資源管理**：電池、煤油消耗與 UI 更新
- **生命系統**：受傷、回血、死亡判定
- **護甲系統**：吸收傷害
- **擊退效果**：受傷時被推開
- **QTE 限制**：進行 QTE 時禁止移動/旋轉

**實作介面**：`IDamageable`

---

### `FootstepPlayer.cs` - 腳步聲
**用途**：根據移動播放腳步音效。

---

### `FootstepZone.cs` - 腳步區域
**用途**：不同地形的腳步聲切換。

---

### `PlayerFlashlight.cs` - 手電筒
**用途**：控制玩家手電筒的開關與光線。

---

### `HandCrankFlashlight.cs` - 手搖發電
**用途**：通過手搖為手電筒充電。

---

## 🏃 難民系統 (Refugees/)

### `Refugee.cs` - 難民個體
**用途**：可被護送的 NPC。

---

### `RefugeeManager.cs` - 難民管理
**用途**：追蹤難民的存活狀態。

---

## 🖼️ UI 系統 (UI/)

### `QTE.cs` - QTE 介面
**用途**：環形 QTE 的視覺與邏輯。

**運作方式**：
1. 生成時指針開始旋轉
2. 玩家按下左鍵時判定指針位置
3. 在綠色區域內 = 成功，否則 = 失敗
4. 透過 `QTEStatus` 回報結果

---

### `MainMenuUI.cs` - 主選單
**用途**：開始遊戲、設定、退出等按鈕。

---

### `GameEndUI.cs` - 遊戲結束畫面
**用途**：勝利/失敗畫面的顯示。

---

### `ContainerManager.cs` - 背包 UI
**用途**：顯示並管理背包槽位。

---

### `AmmoUIHandler.cs` - 彈藥 UI
**用途**：顯示當前武器的彈藥數量。

---

### `Compass.cs` - 指南針
**用途**：顯示方向指示。

---

### `Radar.cs` - 雷達
**用途**：小地圖或敵人偵測。

---

### `DistanceMeter.cs` - 距離計
**用途**：顯示到目標的距離。

---

### `Lantern.cs` - 提燈 UI
**用途**：顯示煤油剩餘量。

---

### `SettingSlider.cs` - 設定滑桿
**用途**：音量等設定的滑桿控制項。

---

### `ButtonAnimation.cs` - 按鈕動畫
**用途**：按鈕的 hover/click 動畫效果。

---

## 🔫 武器系統 (Weapons/)

### `Pistol.cs` - 槍械 (通用)
**用途**：處理所有槍械的射擊邏輯。

**主要屬性**：
- `Cooldown` - 射擊冷卻時間
- `IsAuto` - 是否自動射擊 (按住連發)
- `BulletObject` - 子彈 Prefab
- `ammoType` - 使用的彈藥類型

**運作方式**：
1. 監聽 `Attack` 輸入
2. 檢查冷卻與彈藥
3. 從物件池生成子彈
4. 播放音效、扣除彈藥

---

### `Bow.cs` - 弓箭
**用途**：蓄力射擊的遠程武器。

---

### `MeleeWeapon.cs` - 近戰武器
**用途**：刀、斧等近戰武器的攻擊邏輯。

---

### `Bullet.cs` - 子彈
**用途**：玩家發射的投射物。

**屬性**：
- `Damage` - 傷害值
- `KnockbackDistance` - 擊退距離
- `KnockbackVelocity` - 擊退速度

**運作方式**：
1. 向前移動
2. 碰到 `IDamageable` 時調用 `TakeDamage()`
3. 碰到障礙物時回收到物件池

---

## 🔄 系統運作流程

### 戰鬥流程
```
玩家按下攻擊鍵 → Pistol.Shoot() → 生成 Bullet
    ↓
Bullet 碰撞敵人 → 查找 IDamageable
    ↓
調用 Zombie.TakeDamage() → 扣血、擊退、播放音效
    ↓
血量歸零 → LootDropper.DropLoot() → 銷毀敵人
```

### 門解鎖流程
```
玩家進入 DoorTrigger → DoorController.OnPlayerEnter()
    ↓
檢查 isLocked → 是 → 檢查鑰匙
    ↓
有鑰匙 → StartQTE() → 生成 QTE UI
    ↓
玩家點擊 → QTE 判定 → 成功 → CompleteUnlock() → StartOpen()
    ↓                    → 失敗 → 標記需重新進入
```

### 音效音量流程
```
個別音效的 localVolume × SoundManager.GetVolume() = 最終音量
```

---

## 📝 重要設計原則

1. **靜態資料中心**：`Informations` 儲存所有共享狀態
2. **Singleton 管理器**：`SoundManager`、`ObjectPoolManager` 等確保全域唯一
3. **介面抽象**：`IDamageable` 統一傷害處理
4. **事件驅動**：`QTEStatus.OnQTEForceFail` 允許跨腳本通訊
5. **物件池優化**：子彈等高頻物件使用池化

---

*文件產生時間：2025-12-30*
